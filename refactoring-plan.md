# План подготовки к релизу

Документ объединяет результаты работы **Senior QA Engineer** (регресс-тестирование и отчёт о багах) и **Senior Fullstack Developer** (план рефакторинга, исправления багов, оптимизации). Внешний вид и вёрстка в результате выполнения плана не меняются.

---

## Часть 1. Senior QA Engineer

### 1.1 План регресс-тестирования приложения

План составлен для тестирования по коду (без визуальной проверки).

| № | Область | Что проверять |
|---|---------|----------------|
| 1 | Маршруты и контроллеры | Все маршруты в `routes/web.php` возвращают ожидаемый тип ответа; POST `/leads` вызывает `LeadController::store`, валидация полей `name`, `phone`, `personal_data_consent`. |
| 2 | Главная страница | Загрузка отзывов и FAQ из БД; fallback при пустых таблицах; передача `$reviews` и `$faqs` во view `welcome` и в компоненты `x-reviews`, `x-faq`. |
| 3 | Заявки (Leads) | Создание записи в БД с полями `name`, `phone`, `status = 'new'`; редирект `back()` с флешем `lead_success`; при ошибке валидации — редирект с ошибками (без падения). |
| 4 | Страницы about, contact, requisites, legal/* | Использование переменной `$settings` (View composer в `AppServiceProvider`); отсутствие обращений к несуществующим свойствам; формы на contact и в модалке ведут на `route('leads.store')`. |
| 5 | API `/api/employees` | Параметр `q` (минимум 2 символа); фильтрация по `employee_id`, `full_name`, `is_active = true`; экранирование `%`, `_`, `\` в LIKE; ответ `{ docs: [...] }`. |
| 6 | API `/api/phones/check` | Нормализация номера (8/7, 10/11 цифр); поиск по активным номерам; ответы `found: true/false`, при `true` — `phone_number`, `description`. |
| 7 | Модели | Lead, Review, Faq, CompanySetting, Employee, Phone, User — корректные атрибуты и связи; Review: `photo_url`, `review_date`, `is_visible`; CompanySetting::getSingleton() при пустой таблице создаёт запись. |
| 8 | Filament Admin | Ресурсы Lead, Review, Faq, Employee, Phone — форма и таблица; страница «Реквизиты» (EditCompanySettings) — сохранение настроек через `CompanySetting::first()`/`create`/`update`; авторизация (User::canAccessPanel). |
| 9 | Миграции | Порядок и совместимость: leads, reviews, faqs, company_settings, employees, phones; наличие колонок `photo`, `review_date` в reviews; уникальность `phone_number` в phones. |
| 10 | Безопасность и валидация | CSRF на формах; валидация lead (required, accepted consent); отсутствие массового присвоения уязвимых полей в моделях с `$guarded = []`. |

---

### 1.2 Отчёт о багах и проблемах (Senior QA Engineer)

Ниже перечислены реальные проблемы, выявленные при анализе кода.

#### Критичные / высокий приоритет

1. **Ошибки валидации формы заявки в модалке не видны пользователю**  
   При отправке формы в модалке (`x-lead-modal`) с ошибкой валидации происходит редирект `back()` с ошибками, но модалка по умолчанию закрыта (`showModal: false`). Сообщения `@error('phone')`, `@error('name')` и т.д. находятся внутри скрытой модалки — пользователь не видит, что именно не так.

2. **Производительность API `/api/phones/check`**  
   Загружаются все активные телефоны `Phone::query()->where('is_active', true)->get()`, затем в PHP выполняется нормализация и сравнение с введённым номером. При росте числа записей запрос не масштабируется и создаёт лишнюю нагрузку на БД и память.

3. **Отсутствие кэширования настроек компании**  
   В `AppServiceProvider` View composer по шаблону `*` при каждой отрисовке любого view вызывает `CompanySetting::first()`. На каждой странице (включая Filament) выполняется запрос к БД без кэша.

4. **Массовое присвоение (mass assignment)**  
   В моделях Lead, Review, Faq, CompanySetting используется `$guarded = []`, то есть все атрибуты разрешены к массовому присвоению. Риск: при появлении полей из запроса пользователя (например, через Filament или будущие API) можно перезаписать служебные поля.

#### Средний приоритет

5. **Бизнес-логика в маршрутах**  
   В `routes/web.php` в замыканиях выполняется выборка отзывов, FAQ, логика API employees и phones/check. Это усложняет тестирование и нарушает разделение ответственности (логику лучше переносить в контроллеры/сервисы).

6. **Нет ограничения частоты запросов (rate limiting)**  
   Маршруты POST `/leads`, GET `/api/employees`, GET `/api/phones/check` не защищены throttle- middleware. Возможны спам заявок и перебор API.

7. **Неточная дата в fallback-отзывах на главной**  
   В fallback-коллекции отзывов при пустой БД используются даты с годом `2026` (например `Carbon::parse('2026-01-15')`). Логически для «реальных» отзывов ожидается текущий или прошлый год.

8. **Опечатка в имени миграции**  
   Файл миграции телефонов назван `2026_01_30_092955_create_phones_table.php` (год 2026). Ожидаемый год — 2025, чтобы миграция шла в правильном порядке относительно остальных.

9. **Доступ в админ-панель**  
   `User::canAccessPanel()` всегда возвращает `true`, то есть любой залогиненный пользователь может войти в админку. Для продакшена часто требуется ограничение по email или роли (оставить как есть только если это осознанное решение).

#### Низкий приоритет / улучшения

10. **LeadController**  
    Нет `declare(strict_types=1)` и отдельного Form Request для валидации заявки (валидация в контроллере — нормально, но Form Request улучшает структуру).

11. **Review::getPhotoUrlAttribute**  
    Используется `$this->attributes['photo'] ?? $this->photo` — избыточно, достаточно одного источника (например, только атрибута).

12. **Внешняя зависимость в Filament**  
    В ReviewResource в ImageColumn используется `defaultImageUrl` с внешним URL (ui-avatars.com). При недоступности сервиса аватар по умолчанию может не загружаться (низкий риск).

13. **View composer на все шаблоны**  
    `View::composer('*', ...)` передаёт `$settings` во все view, в том числе в панель Filament. Для админки переменная не нужна — можно сузить список шаблонов до фронтовых.

---

## Часть 2. Senior Fullstack Developer

### 2.1 План рефакторинга и оптимизации кода

- [x] Вынести логику главной страницы из замыкания маршрута в отдельный контроллер (например `HomeController@index`): выборка отзывов и FAQ, формирование fallback, возврат view.
- [x] Вынести логику API сотрудников в контроллер или сервис (например `Api\EmployeeController@search` или `EmployeeSearchService`): поиск по `q`, экранирование LIKE, формат ответа.
- [x] Вынести логику API проверки телефона в контроллер/сервис (например `Api\PhoneCheckController@check` или `PhoneCheckService`) с последующей оптимизацией запроса к БД (см. п. 2.7).
- [x] Ввести Form Request для создания заявки (например `StoreLeadRequest`) с правилами валидации и при необходимости кастомными сообщениями; использовать в `LeadController::store`.
- [x] Добавить `declare(strict_types=1);` в LeadController и при необходимости в другие контроллеры/классы по стандартам проекта.
- [x] Заменить в моделях Lead, Review, Faq, CompanySetting использование `$guarded = []` на явный `$fillable` с перечислением разрешённых атрибутов.
- [x] В Review::getPhotoUrlAttribute оставить один способ получения значения (например только из атрибута), убрать избыточную проверку.
- [x] Сузить View composer для `$settings`: не `*`, а список конкретных view (например только фронтовые layout и страницы), чтобы не передавать переменную в Filament.
- [x] При необходимости выделить общую логику нормализации телефона в хелпер или сервис и использовать в API и при сохранении/сравнении.

Планируя изменения, проверять, что существующие маршруты, формы и Filament-ресурсы продолжают работать без регрессий.

---

### 2.2 План исправления багов, найденных Senior QA Engineer

- [x] **Баг 1 — ошибки валидации в модалке не видны**  
  При редиректе после ошибки валидации формы заявки из модалки — открывать модалку на фронте. Варианты: передавать флаг в session (например `lead_modal_errors`) и во view при наличии ошибок полей lead выставлять начальное состояние модалки открытой (например через `x-data="{ showModal: {{ $errors->has('phone') || $errors->has('name') ? 'true' : 'false' }} }"` на контейнере с `x-data` у welcome) или через `x-init` в модалке. Не менять разметку/стили, только логику открытия.

- [x] **Баг 2 — производительность `/api/phones/check`**  
  Не загружать все телефоны. Варианты: хранить в БД нормализованный номер (колонка `normalized_phone` или аналог) и искать одним запросом по нему; либо нормализовать ввод и строить запрос с LIKE/равенством по нормализованному значению, если нормализация в БД не добавляется. Убрать `->get()` с последующей фильтрацией в PHP.

- [x] **Баг 3 — кэширование настроек компании**  
  В View composer кэшировать результат `CompanySetting::first()` (например ключ `company_settings`, TTL по необходимости, инвалидация при обновлении в EditCompanySettings). Использовать `Cache::remember()` или аналог. При сохранении реквизитов в Filament — сбрасывать кэш.

- [x] **Баг 4 — mass assignment**  
  В Lead, Review, Faq, CompanySetting задать `$fillable` и удалить `$guarded = []`. В Filament и при создании/обновлении через код использовать только поля из `$fillable`.

- [x] **Баг 5 — бизнес-логика в маршрутах**  
  Реализовано в п. 2.1 (вынос в контроллеры/сервисы).

- [x] **Баг 6 — rate limiting**  
  Добавить throttle для POST `leads.store` (например 10 запросов в минуту) и для GET `/api/employees`, `/api/phones/check` (например 60 в минуту). Использовать `throttle` в `routes/web.php` или middleware.

- [x] **Баг 7 — год в fallback-отзывах**  
  Заменить в `routes/web.php` (или в контроллере после выноса) год в датах fallback-отзывов с 2026 на 2025 (или на текущий год по логике продукта).

- [ ] **Баг 8 — имя миграции телефонов**  
  Переименовать файл миграции с `2026_01_30_092955_create_phones_table.php` на год 2025 (например `2025_01_30_092955_create_phones_table.php`). Учесть: если миграции уже выполнялись в окружении, может потребоваться только для новых установок или осторожное переименование с учётом истории миграций. *Не выполнено: оставлен год 2026 во избежание поломки уже выполненных миграций.*

- [ ] **Баг 9 — canAccessPanel**  
  По решению продукта: либо оставить `return true`, либо ограничить доступ (например по email или роли) и обновить метод.

- [x] **Баг 10–13**  
  Учтены в п. 2.1 (Form Request, Review accessor, View composer, при необходимости — локальный fallback для аватара в Filament без смены UI).

---

### 2.3 Самостоятельное тестирование разработчика и дополнительные баги

- [ ] **Проверка редиректа после отправки заявки**  
  Убедиться, что после успешной отправки заявки редирект идёт на предыдущую страницу и отображается сообщение об успехе (флеш `lead_success`). Проверить сценарий отправки из модалки на главной и с формы на странице контактов.

- [ ] **Проверка обязательности согласия с обработкой персональных данных**  
  Правило `personal_data_consent` => ['required', 'accepted'] должно отклонять запрос при отсутствии или не отмеченном чекбоксе. Проверить, что ошибка отображается (на странице контактов — в форме; после исправления бага 1 — и в модалке).

- [ ] **Проверка API employees при коротком `q`**  
  При `q` длиной меньше 2 символов ответ должен быть `{ docs: [] }` без запроса к БД по полному списку.

- [ ] **Проверка EditCompanySettings**  
  При первом открытии страницы «Реквизиты» вызывается `CompanySetting::getSingleton()`; при сохранении — `CompanySetting::first()` и затем `update` или `create`. Убедиться, что при пустой таблице создаётся одна запись и не возникает дублей.

- [x] **Дополнительный баг: Faq sort_order в форме Filament**  
  Поле `sort_order` — `TextInput::make('sort_order')->numeric()`; пользователь может ввести дробное число. В миграции — `unsignedInteger`. Имеет смысл привести к целому (например `->integer()` в форме или cast в модели Faq на integer), чтобы не было неожиданного поведения при сортировке и reorderable.

План исправления дополнительных находок:

- [x] Добавить cast `sort_order` => 'integer' в модель Faq (если ещё нет) и/или в форме Filament использовать правило integer для `sort_order`.
- [x] После внедрения кэша настроек — проверить, что после сохранения реквизитов в админке на фронте отображаются обновлённые данные (инвалидация кэша срабатывает).

---

### 2.4 Неиспользуемый код

- [x] **tests/Unit/ExampleTest.php**  
  Класс наследует `PHPUnit\Framework\TestCase`, а не `Tests\TestCase` (Laravel). Тест не использует приложение Laravel. Либо перевести на `Tests\TestCase` и при необходимости добавить осмысленный unit-тест, либо пометить/удалить как заглушку, чтобы не создавать впечатления покрытия.

- [ ] **tests/Feature/ExampleTest.php**  
  Содержит только один тест — проверка GET `/`. Для релиза полезно оставить как минимальный smoke-тест; при расширении плана тестирования — добавить тесты на POST `/leads`, API и т.д.

- [ ] Проверить импорты в Filament-ресурсах и контроллерах: неиспользуемые импорты (например лишние `use`) удалить.

- [ ] В `web.php` после выноса логики в контроллеры в замыканиях не должно оставаться дублирующей логики; неиспользуемые переменные в view после рефакторинга удалить.

---

### 2.5 Оптимизация работы с базой данных и кэширование

- [x] **Индексы**  
  Проверить наличие индексов (и при необходимости добавить миграциями):  
  - `leads`: по `status`, по `created_at` (для списка в админке и фильтрации).  
  - `reviews`: по `is_visible`, по `review_date` или `(is_visible, review_date)` (для выборки на главную).  
  - `faqs`: по `sort_order` (для сортировки).  
  - `employees`: по `is_active`, по `employee_id` (для API поиска).  
  - `phones`: по `is_active`; при введении поиска по нормализованному номеру — индекс по колонке нормализованного номера.

- [x] **Кэширование**  
  - Настройки компании: кэш в View composer (см. п. 2.2, баг 3), инвалидация при сохранении в EditCompanySettings.  
  - При необходимости: кэш для списка активных телефонов (с коротким TTL или инвалидация при изменении в PhoneResource), только если после оптимизации запроса к БД всё ещё нужна дополнительная разгрузка.

- [x] **Запросы**  
  - Главная: текущий запрос отзывов и FAQ уже ограничен (take(6) и один запрос FAQ); после выноса в контроллер сохранить текущее поведение.  
  - API phones: уйти от загрузки всех записей (см. п. 2.2, баг 2).

---

### 2.6 Пагинация

- [ ] **Главная страница**  
  Отзывы и FAQ ограничены (6 отзывов и все FAQ). Для лендинга пагинация не требуется. Если в будущем появится страница «Все отзывы», добавить пагинацию (например через `paginate()` и стандартный вывод Laravel или через Filament на фронте).

- [ ] **Filament**  
  Таблицы в ресурсах Lead, Review, Faq, Employee, Phone используют стандартную пагинацию Filament. Проверить, что размер страницы по умолчанию приемлем (например 10–25 записей). При необходимости задать `->defaultPaginationPageOption()` в методе `table()` каждого ресурса.

- [ ] **API `/api/employees`**  
  Сейчас возвращается до 10 записей (`limit(10)`). Для автодополнения этого достаточно. Пагинация не обязательна; при расширении API при необходимости добавить параметры `page`/`per_page`.

---

## Контроль перед релизом

- [ ] Все пункты плана рефакторинга и исправления багов выполнены или осознанно отложены с пометкой.
- [ ] Регресс-тестирование по п. 1.1 проведено после изменений.
- [ ] Внешний вид и вёрстка (UI, стили) не изменены.
- [ ] Миграции выполняются в корректном порядке; при переименовании миграции учтена история окружений.
